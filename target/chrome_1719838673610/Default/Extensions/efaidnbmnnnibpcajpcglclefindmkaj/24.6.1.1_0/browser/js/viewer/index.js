/*************************************************************************
* ADOBE CONFIDENTIAL
* ___________________
*
*  Copyright 2015 Adobe Systems Incorporated
*  All Rights Reserved.
*
* NOTICE:  All information contained herein is, and remains
* the property of Adobe Systems Incorporated and its suppliers,
* if any.  The intellectual and technical concepts contained
* herein are proprietary to Adobe Systems Incorporated and its
* suppliers and are protected by all applicable intellectual property laws,
* including trade secret and or copyright laws.
* Dissemination of this information or reproduction of this material
* is strictly forbidden unless prior written permission is obtained
* from Adobe Systems Incorporated.
**************************************************************************/
import{dcLocalStorage as e,dcSessionStorage as t}from"../../../common/local-storage.js";import{dcTabStorage as a}from"../tab-storage.js";import{util as n}from"../content-util.js";import{signInUtil as r}from"./signInUtils.js";import{privateApi as i}from"../content-privateApi.js";import{COOLDOWN_FOR_LFT_PROMPT as o,OptionPageActions as s,LOCAL_FILE_PERMISSION_URL as c,LOCAL_FTE_WINDOW as d}from"../../../common/constant.js";import{indexedDBScript as l}from"../../../common/indexDB.js";import{loggingApi as m}from"../../../common/loggingApi.js";import{updateExtUserState as g,isNewUser as p}from"../../../common/util.js";import f from"./ResponseHeaders.js";import u from"./BookmarkUtils.js";import h from"./LruUtil.js";import{events as w}from"../../../common/analytics.js";await e.init(),await t.init();const I=e.getItem("appLocale");let b=!1;!function(){let w,v,_,y,S,L,P,E,T,D,R,k,U,C,B,F,A,x,M,V,O,N,$,H="";const W=chrome.runtime.getURL("viewer.html"),z=chrome.runtime.getURL("signInHandler.html"),j="file:",q=["https:","http:",j],G=e=>{if(!e)return!1;try{const t=new URL(e),a=t.protocol;let n=-1!==q.indexOf(a);return n=a===j?t.pathname.toLowerCase().endsWith(".pdf"):n,n}catch(e){return!1}};function J(e){const t=a.getItem("search");return new URLSearchParams(t).get(e)}function Y(e,t){return C?(B=B||1,e.tabId=B,e.mimeHandled=!0,chrome.runtime.sendMessage(e,t)):chrome.runtime.sendMessage(e,t)}function K(e,t){return new URLSearchParams(e).get(t)||""}function X(){if(y=K(document.location.search,"pdfurl"),N=K(document.location.search,"tabId"),!G(y))return void(S=!1);!function(){const e=new URLSearchParams(document.location.search),n=t.getItem("rtParams");if(n){const a=n.split(",").map((t=>e.has(t)?`&${t}=${e.get(t)}`:null)).join("")||"";t.setItem("payPalUrl",a),t.removeItem("rtParams")}e.has("dialog!dropin")&&a.setItem("dialog!dropin",e.get("dialog!dropin")),e.has("load!dropin")&&a.setItem("load!dropin",e.get("load!dropin"))}();const e=a.getItem("search");(!e||K(e,"pdfurl")!==y||e.length<document.location.search)&&a.setItem("search",document.location.search),_=K(document.location.search,"pdffilename")||K(e,"pdffilename")||we(y),document.title=_;const n="/"+y+location.hash;history.replaceState({},_,n)}function Z(t=!1){if(C)try{t||Y({main_op:"viewer-type",viewer:"mime-native"}),setTimeout((()=>{i.reloadWithNativeViewer({contentLength:parseInt(w)||0})}),100)}catch(e){ee("DCBrowserExt:Viewer:FallbackToNative:Failed")}else try{setTimeout((()=>{chrome.tabs.getCurrent((function(t){e.setItem(`reloadurl-${t.id}`,y),window.location.href=y}))}),500)}catch(e){ee("DCBrowserExt:Viewer:FallbackToNative:Failed")}}const Q=t=>{try{const a=new URL(e.getItem("cdnUrl")),n=[/^https:\/\/([a-zA-Z\d-]+\.){0,}(adobe|acrobat)\.com(:[0-9]*)?$/];return t===a.origin&&!!n.find((e=>e.test(t)))}catch(e){return!1}};function ee(e){const t={main_op:"analytics"};t.analytics=[[e]],Y(t)}function te(){let e,t=W;return C?(e="?mimePdfUrl="+encodeURIComponent(y),t=z):(e=a.getItem("search"),e||(e="?pdfurl="+y)),new URL(t+e)}const ae=["AdobeID","openid","DCAPI","sign_user_read","sign_user_write","sign_user_login","sign_library_read","sign_library_write","agreement_send","agreement_read","agreement_write","ab.manage","additional_info.account_type","sao.ACOM_ESIGN_TRIAL","widget_read","widget_write","workflow_read","workflow_write","tk_platform","tk_platform_sync"];function ne(t={}){if(e.getItem("nsi"))return void function(t={}){const a=te(),r=e.getItem("cdnUrl"),i=t.sign_up?1:0,o=n.generateStateCSRF(),s=e.getItem("enableCSRF"),c=JSON.stringify({touchp:t.touchpoint||"",signIn:!0,newSignIn:1,...s&&{state:o}}),d=e.getItem("theme")||"auto",l=`${r}?la=true&locale=${I||e.getItem("locale")}&theme=${d}&ru=${encodeURIComponent(a.href)}&rp=${c}&su=${i}#/susi`;chrome.tabs.update({url:l,active:!0})}(t);const a=e.getItem("imsURL"),r=e.getItem("viewerImsClientId"),i=e.getItem("imsContextId"),o=new URL(a+"/ims/authorize/v1?"),s=te(),c=n.generateStateCSRF();t.sign_up?(o.searchParams.append("idp_flow","create_account"),s.hash=s.hash+"signUp=true"):s.hash=s.hash+"signIn=true",o.searchParams.append("response_type","token"),o.searchParams.append("client_id",r),t.touchpoint&&(s.hash=s.hash+`;touchp=${t.touchpoint};`),o.searchParams.append("redirect_uri",s),o.searchParams.append("scope",ae.join(",")),o.searchParams.append("dctx_id",i),o.searchParams.append("locale",I||e.getItem("locale")),o.searchParams.append("state",JSON.stringify(c)),chrome.tabs.update({url:o.href,active:!0})}function re(){let e;e=C?te().href:window.location.href,r.sign_out(e)}function ie(e){let t=new URL(z);return t.searchParams.append("socialSignIn","true"),t.searchParams.append("mimePdfUrl",encodeURIComponent(y)),a.setItem("idp_token",e),t.href}function oe(e){C?chrome.tabs.update({url:ie(e),active:!0}):r.socialSignIn(e,te())}function se(t="google"){const r=e.getItem("viewerImsClientIdSocial"),i=e.getItem("imsURL"),o=n.uuid(),s=te();s.hash=s.hash+"signIn=true";const c=new URL(i+"/ims/authorize/v1"),d={ac:n.getAppCode(),csrf:o};a.setItem("csrf",o),c.searchParams.append("response_type","token"),c.searchParams.append("idp_flow","social.deep_link.web"),c.searchParams.append("client_id",r),c.searchParams.append("provider_id",t),c.searchParams.append("redirect_uri",s),c.searchParams.append("scope",ae.join(",")),c.searchParams.append("locale",I||e.getItem("locale")),c.searchParams.append("state",JSON.stringify(d)),c.searchParams.append("xApiClientId",r),c.searchParams.append("xApiClientLocation ",t),chrome.tabs.update({url:c.href,active:!0})}const ce={isSharePointURL:!1,isSharePointFeatureEnabled:!1,isFrictionlessEnabled:!0,featureFlags:[],isFillAndSignRegisteryEnabled:!1};class de{constructor(e){this.iframeElement=void 0,this.parentDiv=e}createIframe=t=>{const a=window.document,n=(e.getItem("cdnUrl"),a.createElement("iframe"));n.setAttribute("src",t),n.setAttribute("id","dc-view-frame"),n.setAttribute("allowfullscreen","allowfullscreen"),n.setAttribute("allow","clipboard-read; clipboard-write;"),n.style.width="100vw",n.style.height="100vh",n.style.border="none",n.style.overflow="hidden",this.parentDiv.appendChild(n),m.info({message:"Viewer Iframe created"}),this.iframeElement=a.getElementById("dc-view-frame")};_sendMessage=(e,t)=>{this.iframeElement&&Q(t)&&function(e){let t=Date.now();return new Promise((function a(n,r){L&&(S||C)?n(S||C):e&&Date.now()-t>=e?r(new Error("timeout")):setTimeout(a.bind(this,n,r),30)}))}(1e6).then((a=>a&&this.iframeElement.contentWindow.postMessage(e,t)))};sendStartupConfigs=(e,a)=>{this._sendMessage({type:"nativeConfigs",nativeConfigs:ce,extUrl:encodeURI(e),returnParamsUrl:t.getItem("payPalUrl"),isInstallTypeUpsell:b},a)};sendFileMetaData=(e,t,a,n,r,i,o,s)=>{this._sendMessage({fileUrl:r,fileName:i,fileSize:a,acceptRanges:n,handShakeTime:t,type:e,isFrictionlessEnabled:ce.isFrictionlessEnabled,isReloadOrBackForward:s,isMimeHandled:C},o)};sendSubmitFormResponse=(e,t)=>{this._sendMessage({type:"submitForm",response:e},t)};sendRecentUrl=async(e,t,a,n=!1)=>{await chrome.extension.isAllowedFileSchemeAccess()||(t=t?.filter((e=>!e.url.startsWith("file://")))),this._sendMessage({type:"RecentUrls",permission:e,showOverlay:n,recentUrls:t},a)};sendProgress=(e,t,a,n)=>{this._sendMessage({total:t,loaded:a,type:e},n)};sendInitialBuffer=(e,t,a,n,r)=>{this._sendMessage({type:e,downLoadstartTime:t,downLoadEndTime:a,buffer:n},r)};sendBufferRanges=(e,t,a,n)=>{this._sendMessage({type:e,range:t,buffer:a},n)};preview=(e,t,n,r,i,o,s)=>{const c="true"===a.getItem("bufferFromIndexedDB");a.removeItem("bufferFromIndexedDB"),this._sendMessage({fileSize:n,type:e,fileBuffer:t,fileName:r,downLoadstartTime:i,downLoadEndTime:o,fromIndexedDB:c},s)};openInAcrobatResponse=(e,t,a)=>{this._sendMessage({type:e,res:t},a)};postLog=(e,t,a,n,r)=>{this._sendMessage({type:e,reqId:t,message:a,error:n},r)};sendCertificateValidationResponse=(e,t)=>{this._sendMessage({type:"certificateValidationResponse",response:e},t)}}function le(t,a){try{R=void 0!==R?R:"false"!==e.getItem("logAnalytics")&&"false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),R&&(T&&v?T.postLog("log",D,t,a,v.origin):setTimeout((()=>{T&&v&&T.postLog("log",D,t,a,v.origin)}),500))}catch(e){}}function me(){let e;return e=C?y:window.location.href,e}function ge(){const t=me(),n=(t.split("#")||[]).pop();if(n.indexOf("access_token=")>-1)try{const i=new URLSearchParams(n).get("access_token"),{client_id:o}=JSON.parse(window.atob(i.split(".")[1]))||{},s=e.getItem("viewerImsClientId");if([s,e.getItem("viewerImsClientIdSocial")].includes(o)){const e=a.getItem("csrf");a.removeItem("csrf");const n=r.parseCSRF(new URL(t));(!e||!n||n!==e)&&(ee("DCBrowserExt:Viewer:User:Error:NonMatchingCsrfToken:FailedToLogin"),re())}}catch{}}function pe(t,a,n,r,i){i&&t.forEach((e=>{n.has(e)&&a.searchParams.append(e,n.get(e))})),r&&t.forEach((t=>{""!==e.getItem(t)&&a.searchParams.append(t,e.getItem(t))}))}const fe=()=>{try{const r=e.getItem("cdnUrl"),i=new URL(r);if(!Q(i.origin))return le("Invalid CDN URL detected","Invalid Origin"),void Z();v||(v=i);let o=e.getItem("viewer-locale");o||(o=e.getItem("locale"));const s="false"!==e.getItem("logAnalytics"),c="false"!==e.getItem("ANALYTICS_OPT_IN_ADMIN"),d=s&&c?"true":c?"optinOff":"gpoOff",l="true"===e.getItem("betaOptOut");i.searchParams.append("locale",I||o),i.searchParams.append("logAnalytics",d),i.searchParams.append("callingApp",chrome.runtime.id),i.searchParams.append("betaOptOut",l),i.searchParams.append("lfa",e.getItem("isAllowedLocalFileAccess")||"false"),i.searchParams.append("enableCaretMode",x),t.getItem("signInTp")&&i.searchParams.append("touchp",t.getItem("signInTp")),i.searchParams.append("rvu",e.getItem("userState")?.rvu??null);const m=e.getItem("installType")||"update",g=e.getItem("installSource");i.searchParams.append("version",`${chrome.runtime.getManifest().version}:${m}`),i.searchParams.append("installSource",g),i.searchParams.append("storage",JSON.stringify(e.getItem("viewerStorage")||{})),i.searchParams.append("tabId",N),"false"===e.getItem("staticFteCoachmarkShown")&&i.searchParams.append("showFTECoachmark","true"),"true"!==J("googlePrint")&&!0!==F||"false"===a.getItem("googleAppsPrint")||i.searchParams.append("googleAppsPrint","true"),i.searchParams.append("sdp",e.getItem("sdp")?"1":"0"),i.searchParams.append("sds",e.getItem("sds")?"1":"0");const f=O.read(y);f&&(delete f.filename,delete f.lastVisited,i.searchParams.append("docState",JSON.stringify(f))),i.searchParams.append("nu",p()),i.searchParams.append("rs",e.getItem("rs")?"1":"0"),i.searchParams.append("nm",e.getItem("supportNightMode")?"1":"0"),i.searchParams.append("dpt",e.getItem("isDarkPageThemeEnabled")?"1":"0"),i.searchParams.append("adminDisableGenAI","true"===e.getItem("DISABLE_GENAI_BY_ADMIN")?"1":"0");const u=["dropin!","provider!","app!","forceDisableGenAI"],h=["analytics","logToConsole","enableLogging","frictionless","sessionId","linearization","ev","ao"],w=["rrv","isReadAloudEnable","isDeskTop","isAcrobat","theme","defaultOwnerShipExperiment","sessionId","sgd","sl","ev","fsm","ao","ip","rate","genAI","mv","pi","ks","edd","tpt","lft","fsu"];e.getItem("env");let b;b=C?new URLSearchParams(new URL(y).search):new URLSearchParams(window.location.search),pe(h,i,b,!1,!0),pe(w,i,b,!0,!1);n=i,["dialog!dropin","load!dropin"].forEach((e=>{""!==(a.getItem(e)||"")&&n.searchParams.append(e,a.getItem(e))}));let _=i.href;u.forEach((e=>{b.forEach(((t,a)=>{a.startsWith(e)&&(_=_+"&"+a+"="+t)}))})),""===t.getItem("payPalUrl")||""===a.getItem("dialog!dropin")&&""===a.getItem("load!dropin")||(_+=t.getItem("payPalUrl"));const S=a.getItem("access_token");return a.removeItem("access_token"),`${_}${S?`/#${S}`:""}`}catch(e){ee("DCBrowserExt:Viewer:Iframe:Creation:Failed"),Z()}var n},ue=(a,n,r="localStorage")=>{if(n){const i="localStorage"===r?e.getItem(a):t.getItem(a);let o;i&&i.tabsInfo?(o=i.tabsInfo,o.includes(n)||o.push(n)):o=[n],"localStorage"===r?e.setItem(a,{tabsInfo:o}):t.setItem(a,{tabsInfo:o})}},he=()=>{try{e.getItem("enableCSRF")||function(){const e=me();if(e.indexOf("newSignIn=1")>-1)return;if(e.indexOf("access_token")>-1&&a.getItem("signInSource")){const t=a.getItem("csrf"),n=r.parseCSRF(new URL(e));a.removeItem("csrf"),(!t||!n||n!==t)&&(ee("DCBrowserExt:Viewer:User:Error:NonMatchingCsrfToken:FailedToLogin"),re())}}(),function(){try{let e=me();e.indexOf("newSignIn=1")>-1&&r.saveAccessToken(e),e&&e.indexOf("#")>-1&&(r.signInAnalyticsLogging(e),r.checkSignInFromEditVerbPaywall(e),e=e.split("#")[0],C?y=e:(window.location.hash=e,history.replaceState(null,document.title,e)))}catch(e){}}(),C&&(N=B);const n=window.document.getElementById("Adobe-dc-view");C||(w=J("clen")||-1),T=new de(n);const o=fe();T.createIframe(o),g(),window.addEventListener("message",(a=>{!a.data||!Q(a.origin)||P||"hsready"!==a.data.type&&"ready"!==a.data.type||(P=!0,E=(new Date).getTime(),D=a.data.requestId,"on"===a.data.killSwitch?(ee("DCBrowserExt:Viewer:KillSwitch:Turned:On"),e.setItem("pdfViewer","false"),i.setViewerState("disabled"),e.setItem("killSwitch","on"),C?Z(!0):setTimeout((()=>{window.location.href=y}),200)):e.getItem("killSwitch")&&(ee("DCBrowserExt:Viewer:KillSwitch:Turned:Off"),e.removeItem("killSwitch")),t.getItem("signInTp")&&t.removeItem("signInTp"))}))}catch(e){le("Error create Iframe",e)}};function we(e){if(_)return _;let t=e;try{const a=e.split("?")[0].split("/").filter((e=>e.length>0)),n=a.length>0?a[a.length-1]:"untitled";t=n;const r=n.length-4;(n.length<4||n.toLowerCase().indexOf(".pdf")!==r)&&(t+=".pdf")}catch(e){le("Error in getFileNameFromURL",e)}return t}function Ie(e,t){return new Promise(((a,n)=>{const r=(new Date).getTime(),i=new XMLHttpRequest;i.open("GET",e.url),i.responseType="arraybuffer",i.setRequestHeader("Range",`bytes=${t.start}-${t.end}`),i.onload=()=>{if(4===i.readyState&&206===i.status)a({buffer:i.response,startTime:r,endTime:(new Date).getTime()});else if(200===i.status){const e={status:i.status,statusText:i.statusText,fileSize:w,rangeBufferSize:i.response.byteLength,range:t};n({message:"Unexpected response to get file buffer range",error:e})}else{const e={status:i.status,statusText:i.statusText,fileSize:w,range:t};n({message:"Invalid response to get file buffer ranger",error:e})}},i.onerror=e=>{n({message:"Error to get file buffer range",error:e})},i.ontimeout=e=>{n({message:"Timeout to get file buffer range due to timeout",error:e})},i.send()}))}function be(e,t){"PDF"===function(e){if(e)try{let t=new URL(e).pathname;return t.substr(t.lastIndexOf(".")+1).toUpperCase()}catch(e){return""}return""}(e)&&(S=!0);const a=new XMLHttpRequest;a.open("GET",e),a.responseType="arraybuffer",a.onreadystatechange=function(){4===a.readyState&&(200!==a.status&&0!=a.status||(t({buffer:a.response,mimeType:a.getResponseHeader("content-type")}),_e(a.response)))},a.send(null)}async function ve(){try{const t=a.getItem("bufferTabId");if(t){const e=await l.getDataFromIndexedDB(t);if(e&&e.fileBuffer)return a.setItem("bufferFromIndexedDB",!0),S=!0,{buffer:e.fileBuffer}}else{const t=e.getItem("tabIdMap");if(t){const n=(C?await chrome.tabs.query({active:!0,currentWindow:!0}):[await chrome.tabs.getCurrent()])[0];if(n&&t[n.id]){a.setItem("bufferTabId",t[n.id]);const r=await l.getDataFromIndexedDB(t[n.id]);if(Object.keys(t).length>1?(delete t[n.id],e.setItem("tabIdMap",t)):e.removeItem("tabIdMap"),r&&r.fileBuffer)return a.setItem("bufferFromIndexedDB",!0),S=!0,{buffer:r.fileBuffer}}}}}catch(e){}return a.setItem("bufferFromIndexedDB",!1),{}}function _e(e){const t=O.read(y)||{},a=new Blob([e],{type:"application/pdf"}),n={main_op:"getFileBuffer",fileBufferBlob:URL.createObjectURL(a),tabId:N,docLastOpenState:t,target:"offscreen"};chrome.runtime.sendMessage(n)}function ye(e,t,a){return new Promise(((n,r)=>{const i=y;if(i.startsWith("file://"))return void be(i,n);const o=new XMLHttpRequest;var s;o.open("GET",i),o.responseType="arraybuffer",t&&o.setRequestHeader("If-Range","randomrange"),o.onreadystatechange=(s=o,function(e){if(this.readyState==this.HEADERS_RECEIVED){if(!function(e,t){const a=e.getResponseHeader("content-type"),n=e.getResponseHeader("content-disposition");if(a){const e=a.toLowerCase().split(";",1)[0].trim();if(n&&/^\s*attachment[;]?/i.test(n))return!1;if("application/pdf"===e)return!0;if("application/octet-stream"===e&&n&&/\.pdf(["']|$)/i.test(n))return!0}return!1}(s))return le("Fall back to native - not pdf from headers"),Z();S=!0}}),o.onprogress=function(e,t){return function(a){a.lengthComputable&&(w=a.total,e.sendProgress("progress",a.total,a.loaded,t))}}(e,a),o.onload=()=>{if(o.status>=200&&o.status<400)n({buffer:o.response,mimeType:o.getResponseHeader("content-type"),downLoadEndTime:(new Date).getTime()}),_e(o.response);else{const e={status:o.status,statusText:o.statusText};r({message:"Invalid response fetching content",error:e})}},o.onerror=e=>{r({message:"Error to download file contents",error:e})},o.ontimeout=e=>{r({message:"Timeout to download file contents",error:e})},o.send()}))}function Se(e,t){ee(`DCBrowserExt:Viewer:SignIn:AdobeYolo:${e}:clicked`),chrome.tabs.query({active:!0,currentWindow:!0},(function(e){var t=e[0]&&e[0].id;ue("adobeYoloTabsInfo",t,"sessionStorage")})),Y({main_op:"launchJumpUrl",details:{source:e,userGuid:t}},(t=>{T._sendMessage({type:"adobeYoloJumpResponse",response:t,source:e},v.origin)}))}function Le(e,t,...a){C?l.storeBufferAndCall(e,t,B,...a):chrome.tabs.getCurrent((function(n){l.storeBufferAndCall(e,t,n.id,...a)}))}function Pe(e){T._sendMessage({type:"redirectToAcrobatWeb",response:e},v.origin)}function Ee(r,m){switch(m.data.main_op){case"open_in_acrobat":case"fillsign":!async function(t,a){const r={main_op:"open_in_acrobat"};if("fillsign"===a.data.main_op&&(r.paramName="FillnSign"),r.url=a.data.url,r.click_context="pdfviewer",r.timeStamp=Date.now(),r.filename=a.data&&a.data.filename,a.data.fileBuffer){const e=new Blob([a.data.fileBuffer],{type:"application/pdf"});r.dataURL=URL.createObjectURL(e)}if(A=function(e){"fillsign"===a.data.main_op?t.openInAcrobatResponse("FILLSIGN_IN_DESKTOP_APP",e,a.origin):t.openInAcrobatResponse("OPEN_IN_DESKTOP_APP",e,a.origin),le(`Open In Acrobat - (${a.data.main_op}) response- ${e}`)},e.getItem("isSharepointFeatureEnabled"))if(ce.isSharePointURL)r.workflow_name="SharePoint",r.isSharePointURL=!0,Y(r,A);else{const e=await n.checkForSharePointURL(r.url);r.isSharePointURL=e,e&&(r.workflow_name="SharePoint"),Y(r,A)}else Y(r,A)}(r,m);break;case"complete_conversion":ee("DCBrowserExt:Viewer:Verbs:Conversion:Redirection"),function(e){const t={};t.main_op=e.data.main_op,t.conversion_url=decodeURIComponent(e.data.conversion_url),t.timeStamp=Date.now(),Y(t)}(m);break;case"updateLocale":ee("DCBrowserExt:Viewer:User:Locale:Updated"),e.setItem("viewer-locale",m.data.locale),Y({main_op:"localeChange",locale:m.data.locale}),chrome.tabs.reload();break;case"setInitialLocale":let g=!1;e.getItem("viewer-locale")||(g=!0,e.setItem("viewer-locale",m.data.locale),ee("DCBrowserExt:Viewer:User:Locale:Initial")),m.data.reloadReq&&g&&chrome.tabs.reload();break;case"error-sign-in":!function(e){const t=n.uuid();a.setItem("csrf",t);const r=new URL(e),i=te();i.hash=i.hash+`state=${t}&signInError=true`,r.searchParams.set("redirect_uri",i),chrome.tabs.update({url:r.href,active:!0})}(m.data.url);break;case"deleteViewerLocale":e.getItem("viewer-locale")&&(e.removeItem("viewer-locale"),chrome.tabs.reload());break;case"signin":ee("DCBrowserExt:Viewer:Ims:Sign:In"),a.setItem("signInSource",m.data.source),ee(`DCBrowserExt:Viewer:Ims:Sign:In:${m.data.source}`),Le(m.data.fileBuffer,ne,{touchpoint:m.data.tp});break;case"googleSignIn":ee("DCBrowserExt:Viewer:Ims:Sign:In"),ee(`DCBrowserExt:Viewer:Ims:Sign:In:${m.data.source}`),a.setItem("signInSource",m.data.source),Le(m.data.fileBuffer,se,m.data.application);break;case"signup":ee("DCBrowserExt:Viewer:Ims:Sign:Up"),a.setItem("signUpSource",m.data.source),ee(`DCBrowserExt:Viewer:Ims:Sign:Up:${m.data.source}`),Le(m.data.fileBuffer,ne,{sign_up:!0});break;case"reload_viewer":chrome.tabs.reload();break;case"upsell_event":!function(e){if(e&&e.url){const a=new URL(decodeURIComponent(e.url));e.returnUrlParams&&t.setItem("rtParams",e.returnUrlParams.toString()),"_blank"===e.target?chrome.tabs.create({url:a.href,active:!0}):chrome.tabs.update({url:a.href,active:!0})}}(m.data);break;case"upsell_remove_urlParams":t.removeItem("rtParams"),t.removeItem("payPalUrl"),a.removeItem("dialog!dropin"),a.removeItem("load!dropin");break;case"fetchLocalRecents":const p=new URL(e.getItem("cdnUrl")).origin;if(m.data.fetchRecents){const e=m.data.showOverlay;!async function(e,t,a=!1){const n=O.getAllItems();e.sendRecentUrl(!0,n,t,a)}(T,p,e)}else T.sendRecentUrl(!0,null,p);break;case"socialSignIn":ee("DCBrowserExt:Viewer:Ims:Sign:In"),ee(`DCBrowserExt:Viewer:Ims:Sign:In:${m.data.source}`),a.setItem("signInSource",m.data.source),Le(m.data.fileBuffer,oe,m.data.idp_token);break;case"openRecentFileLink":const f={};f.main_op=m.data.main_op,f.recent_file_url=decodeURIComponent(m.data.recent_file_url),Y(f);break;case"userSubscriptionData":if(C){const e={};e.eventType=m.data.main_op,e.userSubscriptionData=m.data.userSubscriptionData,e.data=m.data,e.main_op=m.data.main_op;Y(e,(function(e){e&&"showUninstallPopUp"===e.main_op&&T._sendMessage({type:"showUninstallPopUp"},v.origin)}))}break;case"uninstall":C&&Y({main_op:"uninstall",defaultUrl:y});break;case"submit_form":fetch(m.data.resource,m.data.options).then((e=>{T.sendSubmitFormResponse(e.ok,m.origin)})).catch((()=>{T.sendSubmitFormResponse(!1,m.origin)}));break;case"ownerShipExperimentShown":e.removeItem("defaultOwnerShipExperiment");break;case"openAcrobatOptions":chrome.runtime.openOptionsPage(),ee(`DCBrowserExt:Viewer:ManagePref:clicked:${m.data.source}`);break;case"openExtensionSettings":chrome.tabs.query({active:!0,currentWindow:!0},(function(t){const a=t[0];e.setItem("lastOpenTabId",a.id),chrome.windows.get(a.windowId,(function(t){const{height:a}=d,n=Math.round(1.2*d.width),r=Math.round(.5*(t.height-a)+t.top),i=Math.round(.5*(t.width-n)+t.left);chrome.windows.create({height:a,width:n,left:i,top:r,focused:!0,type:"popup",url:c},(t=>{e.setItem("settingsWindow",t)}))}))})),e.setItem("LocalFileAccessTouchpointsFromViewer",!0),setTimeout((()=>{e.removeItem("LocalFileAccessTouchpointsFromViewer")}),o),Y({main_op:"triggerBufferSave"});break;case"encryptedWriteFile":({secureString:H}=m.data),ke(document.title);break;case"launchJump":Le(m.data.fileBuffer,Se,m.data.source,m.data.userGuid);break;case"saveAsEvent":!async function(e){try{if(ee("DCBrowserExt:Viewer:SaveToMyComputer:"+(V?"fileHandlerExist":"fileHandlerNotExist")),V)$=!1;else{const t={suggestedName:`${e.fileName}.pdf`,types:[{description:"PDF file",accept:{"application/pdf":[".pdf"]}}]};V=await window.showSaveFilePicker(t),$=!0,ke(V?.name)}T._sendMessage({type:"newSaveToLocalResponse",newAsset:$,updatedFileName:V?.name},v.origin)}catch(e){V=null,le("Save As Handler Error",e),T._sendMessage({type:"newSaveToLocalResponse",error:e},v.origin)}}(m.data);break;case"downloadFile":!async function(e){try{let t=e.fileUrl;if(!t){const a=new Blob([e.fileBuffer],{type:"application/pdf"});t=URL.createObjectURL(a)}chrome.downloads.onChanged.addListener(Ne),await chrome.downloads.download({url:t,conflictAction:"uniquify",saveAs:!0,...e.fileName&&{filename:`${e.fileName}.pdf`}})}catch(e){le("downloadFile error",e),T._sendMessage({type:"downloadFileError"},v.origin)}}(m.data);break;case"rememberSaveLocationPreference":!function(t){let a="";t.cloudStorage&&!e.getItem("selectedSaveLocationPreference")?a="PreferenceMigrationSuccess":t.cloudStorage||(a="SaveDialogRememberMe");a&&ee(`DCBrowserExt:Viewer:ChangeSaveLocationPreference:${a}`);(!t.cloudStorage||t.cloudStorage&&!e.getItem("selectedSaveLocationPreference"))&&(e.setItem("saveLocation",t.saveLocation),e.setItem("selectedSaveLocationPreference",!0),Y({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"saveLocationPreferenceTitle",toggleVal:t.saveLocation}))}(m.data);break;case"appRenderingDone":$e();break;case"saveFileBuffer":Le(m.data.fileBuffer);break;case"deleteFileBuffer":const h=a.getItem("bufferTabId");h&&l.deleteDataFromIndexedDB(h),a.removeItem("bufferTabId");case"appRenderingDone":$e();break;case"writeToLocalSavedFile":!async function(e){try{const t=await V.createWritable();await t.write(e.fileBuffer),await t.close(),T._sendMessage({type:"newSaveToLocalResponse",newAsset:$,updatedFileName:V?.name,isFileWriteStage:!0},v.origin)}catch(e){V=null,le("Write to Local File Error",e),T._sendMessage({type:"newSaveToLocalResponse",error:e,isFileWriteStage:!0},v.origin)}}(m.data);break;case"bookmarkWeb":u(m.data.url,Pe,ee);break;case"updateDocumentViewState":!function(e){const{documentViewState:t}=e;O.writeAndSyncWithHistory(y,t)}(m.data);break;case"validateEdgeCertificateForDigitalSignature":i.validateCertificate(m.data).then((e=>T.sendCertificateValidationResponse(e,m.origin)));break;case"documentViewThemeChange":!function(t){e.getItem("theme")!==t.data&&(e.setItem("theme",t.theme),Y({panel_op:"options_page",requestType:s.OPTIONS_UPDATE_TOGGLE,toggleId:"appearancePrefTitle",toggleVal:t.theme}));e.getItem("isDarkPageThemeEnabled")!==t.isDarkPageThemeEnabled&&e.setItem("isDarkPageThemeEnabled",t.isDarkPageThemeEnabled)}(m.data)}}function Te(e){try{const t=new TextDecoder("utf-8").decode(e.buffer);let a=!1;-1!=t.indexOf("Linearized 1")?a=!0:-1!=t.indexOf("Linearized")&&ee("DCBrowserExt:Viewer:Linearization:Linearized:Version:Other"),T._sendMessage({type:"Linearization",linearized:a},v.origin)}catch(e){ee("DCBrowserExt:Viewer:Linearization:Linearized:Detection:Failed"),le("Linearization Detection failed",e)}}function De(t,a,n,r){n.then((n=>{const i=n.downLoadEndTime,o=n.buffer;n.buffer.byteLength;t.preview("preview",o,w,_,r,i,a.origin),T._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},v.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&T._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},v.origin)})).catch((e=>(ee("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),Z()))).finally((()=>{e.removeItem("sessionStarted")}))}class Re{constructor(){this.request={main_op:"analytics"}}analytics=e=>{this.request.analytics||(this.request.analytics=[]),this.request.analytics.push([e])};sendAnalytics=()=>{Y(this.request)}}function ke(e){e&&(document.title=e+H)}const Ue=(t,a,n)=>{const r=n?"viewerStorage":"viewerStorageAsync",i=e.getItem(r)||{};i[t]=a,e.setItem(r,i)},Ce=t=>{const a=e.getItem("viewerStorage")||{},n=e.getItem("viewerStorageAsync")||{};delete a[t],delete n[t],e.setItem("viewerStorage",a),e.setItem("viewerStorageAsync",n)};function Be(t,n,r,i){return o=>{try{if(o.data&&o.origin&&Q(o.origin)&&(e=>{try{return e&&e.source&&e.source.top.location.origin==="chrome-extension://"+chrome.runtime.id}catch(e){return!1}})(o)){if(o.data.main_op)return Ee(t,o);switch(o.data.type){case"ready":if(C?async function(t,n,r,i){let o=new Re;L=!0;const s=y;document.title=_;const c=M.getHeaderValue("accept-ranges"),d=!a.getItem("bufferTabId")&&c&&"bytes"===c.toLowerCase()?"true":"false";t.sendFileMetaData("metadata",E,w,d,s,_,n.origin,!1),xe(),r&&r.then((e=>{t.sendInitialBuffer("initialBuffer",e.startTime,e.endTime,e.buffer,n.origin),Te(e)})).catch((e=>{t.sendInitialBuffer("initialBuffer",0,0,-1,n.origin),o.analytics("DCBrowserExt:Viewer:Error:Linearization:InitialBufiled")})),e.removeItem("isReload"),e.removeItem("isBackForward");const l=window.performance&&window.performance.timing&&window.performance.timing.navigationStart,m=ve();(await m).buffer?De(t,n,m,l):(fetch(i.streamUrl).then((e=>{let a=0;return new Response(new ReadableStream({start(r){const i=e.body.getReader();!function e(){i.read().then((({done:i,value:o})=>{i?r.close():(a+=o.byteLength,t.sendProgress("progress",w,a,n.origin),r.enqueue(o),e())})).catch((e=>{r.error(e)}))}()}}))})).then((e=>e.arrayBuffer())).then((a=>{w=a.byteLength,_e(a),t.preview("preview",a,a.byteLength,_,l,(new Date).getTime(),n.origin),T._sendMessage({type:"NavigationStartTime",time:window.performance&&window.performance.timing&&window.performance.timing.navigationStart},n.origin),!0===e.getItem("isSaveLocationPrefEnabled")&&T._sendMessage({type:"changeSaveLocationPreference",saveLocation:e.getItem("saveLocation"),onLoad:!0},n.origin)})).catch((e=>(o.analytics("DCBrowserExt:Viewer:Error:FallbackToNative:FileDownload:Failed"),Z()))),o.sendAnalytics()),le("Viewer loaded")}(t,o,r,n):function(e,t,n,r,i){L=!0;const o=y,s=!a.getItem("bufferTabId")&&J("chunk")||"false",c=window.performance.getEntriesByType("navigation").map((e=>e.type)).includes("reload"),d=window.performance.getEntriesByType("navigation").map((e=>e.type)).includes("back_forward");e.sendFileMetaData("metadata",E,w,s,encodeURI(o),_,t.origin,c||d),xe(),n?n.then((a=>{e.sendInitialBuffer("initialBuffer",a.startTime,a.endTime,a.buffer,t.origin),Te(a)})).catch((a=>{e.sendInitialBuffer("initialBuffer",0,0,-1,t.origin),m.error("Linearization InitialBuffer Failed")})):e.sendInitialBuffer("initialBuffer",0,0,-1,t.origin),De(e,t,r,i),le("Viewer loaded")}(t,o,r,n,i),Y({main_op:"getUserInfoFromAcrobat"},(e=>{T._sendMessage({type:"adobeYoloUserData",...e},v.origin)})),o.data.visitorID){const t=e.getItem("viewerVisitorID");e.setItem("viewerVisitorID",o.data.visitorID),t&&t!==o.data.visitorID&&ee("DCBrowserExt:Analytics:viewerVisitorID:MCMID:Changed")}break;case"getFileBufferRange":!function(e,t){Ie({url:y},e.data.range).then((a=>{U||(U=!0),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,a.buffer,e.origin)})).catch((a=>{ee("DCBrowserExt:Viewer:Error:Linearization:Range:Failed"),t.sendBufferRanges("bufferRanges",`${e.data.range.start}-${e.data.range.end}`,-1,e.origin)}))}(o,t);break;case"previewFailed":k||(ee("DCBrowserExt:Viewer:Error:FallbackToNative:Preview:Failed"),k=!0,Z());break;case"lastUserGuid":e.setItem("lastUserGuid",o.data.value);break;case"signin":ee("DCBrowserExt:Viewer:Ims:Sign:In"),ne();break;case"signout":ee("DCBrowserExt:Viewer:Ims:Sign:Out"),e.removeItem("viewer-locale"),e.removeItem("userDetailsFetchedTimeStamp"),e.removeItem("discoveryExpiryTime"),e.removeItem("viewer-locale"),Le(o.data.fileBuffer,re);break;case"googleAppsPrintShown":a.setItem("googleAppsPrint","false"),ee("DCBrowserExt:Viewer:GoogleApps:Print:Shown");break;case"signInExperimentShown":chrome.tabs.query({active:!0,currentWindow:!0},(function(t){const a=t[0],n=(new Date).getTime();e.setItem("signInExperimentShown",JSON.stringify({currTabId:a.id,timestamp:n}))}));break;case"disableViewer":e.setItem("pdfViewer","false"),chrome.tabs.reload();break;case"signInExperimentClosed":case"signInExperimentSkipped":e.setItem("signInExperimentSuppressed","true");break;case"enableBeta":e.setItem("betaOptOut","false"),chrome.tabs.reload();break;case"disableBeta":e.setItem("betaOptOut","true"),chrome.tabs.reload();break;case"updateTitle":ke(o.data.title);break;case"viewer_set_item":Ue(o.data.key,o.data.value,o.data.startup);break;case"viewer_remove_item":Ce(o.data.key)}}}catch(e){ee("DCBrowserExt:Viewer:Error:MessageHandler:Unknown")}}}function Fe(){if(!P)return ee("DCBrowserExt:Viewer:Error:Handshake:TimedOut"),Z(),!1}const Ae=t=>{try{e.getItem("enableCSRF")&&ge();const n=M.getHeaderValue("content-length");w=n;const r=M.getHeaderValue("accept-ranges"),i=r&&"bytes"===r.toLowerCase();y=t.originalUrl,he(),_=function(){let e;const t=M.getHeaderValue("content-disposition");if(t&&/\.pdf(["']|$)/i.test(t)){const a=/filename[^;=\n\*]?=((['"]).*?\2|[^;\n]*)/.exec(t);null!=a&&a.length>1&&(e=a[1].replace(/['"]/g,""))}return e||(e=we(y)),decodeURIComponent(e)}();const o={url:y},s=new URL(e.getItem("cdnUrl"));v||(v=s);let c=null;const d="false"!==J("linearization")&&!a.getItem("bufferTabId");d&&i&&n>0&&(c=Ie(o,{start:0,end:1024})),window.addEventListener("message",Be(T,t,c)),Me(),setTimeout(Fe,25e3)}catch(e){le("InitMimeHandlerScript failed",e),Z()}};function xe(){if(a.getItem("signInAction")){const e=a.getItem("signInAction");T._sendMessage({type:"signInInformation",action:e,source:"signIn"===e?a.getItem("signInSource"):a.getItem("signUpSource")},v.origin),a.removeItem("signInSource"),a.removeItem("signUpSource"),a.removeItem("signInAction")}}async function Me(){chrome.storage.onChanged.addListener(((t,a)=>{"local"===a&&Object.entries(t).forEach((([t,{newValue:a}])=>{if("theme"===t&&T._sendMessage({type:"themeChange",theme:a},v.origin),"ANALYTICS_OPT_IN_ADMIN"===t){const t="false"!==e.getItem("logAnalytics"),n="false"!==a;T._sendMessage({type:"analyticsTrackingChange",value:t&&n},v.origin)}"saveLocation"===t&&T._sendMessage({type:"changeSaveLocationPreference",saveLocation:a},v.origin),"isDarkPageThemeEnabled"===t&&T._sendMessage({type:"darkPageThemeChange",isDarkPageThemeEnabled:a},v.origin)}))})),await async function(){return b=await i.isInstalledViaUpsell(),b}(),T._sendMessage({type:"setAsyncStorage",storage:e.getItem("viewerStorageAsync")},v.origin),Y({main_op:"viewer-startup",url:y,startup_time:Date.now(),viewer:!0},(e=>{ce.isSharePointURL=!!e.isSharePointURL,ce.isSharePointFeatureEnabled=!!e.isSharePointEnabled,ce.isFrictionlessEnabled=!!e.isFrictionlessEnabled,ce.featureFlags=e.featureFlags,ce.isFillAndSignRegisteryEnabled=e.isFillnSignEnabled;const t=te().href;T.sendStartupConfigs(t,v.origin)})),Y({main_op:"get-features&groups",cachePurge:"LAZY"},(e=>{T._sendMessage({type:"featureGroups",featureGroups:e.featureGroups,featureFlags:e.featureFlags,ffResponse:e.ffResponse},v.origin)})),C?setTimeout((()=>ue("loadedTabsInfo",B)),2e3):Y({main_op:"updateLoadedTabsInfo"}),O.writeAndSyncWithHistory(y,{filename:_,lastVisited:Date.now()})}function Ve(e){Y({main_op:"caret_mode_toggle_handler",toggleCaretModeValue:e})}function Oe(t){if(t.panel_op&&!0===t.reload_in_native&&(delete t.is_viewer,chrome.tabs.reload(t.tabId)),"relay_to_content"!==t.main_op||"dismiss"!==t.content_op)return"relay_to_content"===t.main_op&&"caret_mode_toggle_handler"===t.content_op?T._sendMessage({type:"toggleCaretMode",toggleCaretModeValue:t.status},v.origin):"reset"===t.main_op?T._sendMessage({type:"toggleAnalytics",logAnalytics:t.analytics_on},v.origin):"showUninstallPopUp"===t.main_op?T._sendMessage({type:"showUninstallPopUp"},v.origin):"jumpUrlSuccess"===t.main_op?(!C||t.tabInfo&&t.tabInfo.includes(B))&&T._sendMessage({type:"adobeYoloJumpUrlSuccess"},v.origin):"triggerBufferSave"===t.main_op?T._sendMessage({type:"triggerBufferSave"},v.origin):"showLocalFileAccessToast"===t.content_op&&(t.tabId&&t.tabId!==e.getItem("lastOpenTabId")||T._sendMessage({type:"showLocalFileAccessToast"},v.origin)),!1;{delete t.content_op,delete t.reload_in_native;let e=document.getElementById("__acrobatDialog__");e&&(e.remove(),e=null)}}function Ne(e){chrome.downloads.onChanged.removeListener(Ne),e?.error||T._sendMessage({type:"downloadFileSuccess"},v.origin)}function $e(){const t=e.getItem("userState");let a=!1;if(void 0!==t?.rvu&&(a=!0),!0!==t.rvu){const t={rvu:a};e.setItem("userState",t)}}document.addEventListener("DOMContentLoaded",function(e){const t=(new Date).getTime();let a=window.setInterval((function(){(function(){const e=document.getElementById("dc-view-frame");return e&&e.contentWindow&&1===e.contentWindow.length}()||(new Date).getTime()-t>15e3)&&(window.clearInterval(a),e.call(this))}),200)}((function(){const e=document.getElementById("dc-view-frame");e&&e.contentWindow&&e.contentWindow.focus()}))),void 0!==chrome.runtime&&(O=new h,i.isMimeHandlerAvailable().then((async function(t){if(chrome.runtime.onMessage.addListener(Oe),t){if(C=!0,!window.navigator.onLine&&e.getItem("offlineSupportDisable"))return void Z();e.getItem("sessionStarted")||(e.setItem("sessionId",n.uuid()),e.setItem("sessionStarted",!0));const t=await i.getStreamInfo()||{};M=new f(t.responseHeaders),B=t.tabId;let a=await Y({main_op:"check-is-google-print"});F=a&&a.isGooglePrint,x=await i.caretModeStatus(),i.addCaretModeListener(Ve),Y({main_op:"viewer-preview",startup_time:Date.now(),viewer:!0},(()=>Ae(t))),Y({main_op:"setupWorkerOffscreen"});e.getItem("firstOpenedTabId")||e.setItem("firstOpenedTabId",B)}else X(),(async()=>{try{if(e.getItem("enableCSRF")&&ge(),!G(y))return void(S=!1);he();const t=J("clen")||-1,n=J("chunk")||!1,r="false"!==J("linearization")&&!a.getItem("bufferTabId"),i={url:y},o=(new Date).getTime(),s=new URL(e.getItem("cdnUrl"));_=J("pdffilename")||we(y),document.title=decodeURIComponent(_),v||(v=s);let c=null;const d=r&&n&&t>0;d&&(c=Ie(i,{start:0,end:1024}));const l=ve(),m=(await l).buffer?l:ye(T,d,s.origin);window.addEventListener("message",Be(T,m,c,o)),setTimeout(Fe,25e3)}catch(e){le("InitScript failed",e),Z()}})(),Me()})))}();